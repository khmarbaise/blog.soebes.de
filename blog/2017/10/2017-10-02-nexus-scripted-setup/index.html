<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Previously I was working on a Nexus Repository Manager setup for different environments like a test and a production environment with different privileges, roles, repositories, users etc.
The problem with such setups is simple: You usually do it manually which in consequence is error-prone. If you are doing that more than once, it becomes cumbersome and you are asking yourself: Isn&rsquo;t there a simpler solution to make that setup more reproducible?'>
<meta name='theme-color' content='#6699cc'>

<meta property='og:title' content='Automated Setup of a Repository Manager • Karl Heinz Marbaise'>
<meta property='og:description' content='Previously I was working on a Nexus Repository Manager setup for different environments like a test and a production environment with different privileges, roles, repositories, users etc.
The problem with such setups is simple: You usually do it manually which in consequence is error-prone. If you are doing that more than once, it becomes cumbersome and you are asking yourself: Isn&rsquo;t there a simpler solution to make that setup more reproducible?'>
<meta property='og:url' content='http://localhost:1313/blog/2017/10/2017-10-02-nexus-scripted-setup/'>
<meta property='og:site_name' content='A coders, hackers heaven.....Hm...I do not think so...'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/d9cd3f93adbfb7d88eb68f903aa22a51?s=256'><meta property='article:section' content='Blog'><meta property='article:published_time' content='2017-10-02T19:30:34Z'/><meta property='article:modified_time' content='2017-10-02T19:30:34Z'/><meta name='twitter:card' content='summary'><meta name='twitter:creator' content='@khmarbaise'>

<meta name="generator" content="Hugo 0.40.3" />

  <title>Automated Setup of a Repository Manager • Karl Heinz Marbaise</title>
  <link rel='canonical' href='http://localhost:1313/blog/2017/10/2017-10-02-nexus-scripted-setup/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.67e9c12b.css'><link rel='stylesheet' href='/css/custom.css'><style>
:root{--color-accent:#6699cc;}
</style>

</head>


<body class='page type-blog layout-post has-sidebar'>

  <div class='site'>

    <div id='sidebar' class='sidebar'>
  <a class='screen-reader-text' href='#main-menu'>Skip to Main Menu</a>

  <div class='container'><section class='widget widget-about sep-after'>
  <header>
    
    <div>
      <img class="soebeslogo" src='/images/weblogo.gif'>
    </div>
    
    <h2 class='title site-title '>
     
    </h2>
    <div class='desc'>
    
    </div>
  </header>

</section>
</div>

  <div class='sidebar-overlay'></div>
</div>

    <div class='main'>

      <nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    <a class='screen-reader-text' href='#content'>Skip to Content</a>

<button id='sidebar-toggler' class='sidebar-toggler' aria-controls='sidebar'>
  <span class='screen-reader-text'>Toggle Sidebar</span>
  <span class='open'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="3" y1="12" x2="21" y2="12" />
  <line x1="3" y1="6" x2="21" y2="6" />
  <line x1="3" y1="18" x2="21" y2="18" />
  
</svg>
</span>
  <span class='close'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="18" y1="6" x2="6" y2="18" />
  <line x1="6" y1="6" x2="18" y2="18" />
  
</svg>
</span>
</button>
    <ul><li class='item'>
        <a href='/impressum/'>Impressum</a>
      </li><li class='item'>
        <a href='/categories/'>Categories</a>
      </li><li class='item'>
        <a href='/categories/'>Maven</a>
      </li><li class='item'>
        <a href='/categories/maven-best-practice/'>Maven Best Practices</a>
      </li></ul>
  </div>
</nav>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>A coders, hackers heaven.....Hm...I do not think so...</p><p class='desc site-desc'></p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Automated Setup of a Repository Manager</h1>
      

    </div>
    
<div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2017-10-02T19:30:34Z'>2017, Oct 02</time>
</span>

  <span class='byline'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M21,21V20c0-2.76-4-5-9-5s-9,2.24-9,5v1"/>
  <path d="M16,6.37A4,4,0,1,1,12.63,3,4,4,0,0,1,16,6.37Z"/>
  
</svg>
<span class='screen-reader-text'> by </span><a href='/authors/khmarbaise'>Karl Heinz Marbaise</a></span>
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
5 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <p>Previously I was working on a <a href="https://www.sonatype.com/download-oss-sonatype" target="_blank">Nexus Repository Manager</a> setup for
different environments like a test and a production environment with different <a href="https://help.sonatype.com/display/NXRM3/Security#Security-Privileges" target="_blank">privileges</a>, <a href="https://help.sonatype.com/display/NXRM3/Security#Security-Roles" target="_blank">roles</a>,
<a href="https://help.sonatype.com/display/NXRM3/Configuration#Configuration-RepositoryManagement" target="_blank">repositories</a>, <a href="https://help.sonatype.com/display/NXRM3/Security#Security-Users" target="_blank">users</a> etc.</p>

<p>The problem with such setups is simple: You usually do it manually which in
consequence is error-prone. If you are doing that more than once, it becomes
cumbersome and you are asking yourself: Isn&rsquo;t there a simpler solution to make
that setup more reproducible?</p>

<p>Fortunately there is a solution for that problem.</p>

<p>The <a href="https://help.sonatype.com/display/NXRM3/Repository+Manager+Feature+Matrix" target="_blank">Nexus Repository Manager starting with version 3+</a> provides
a <a href="https://help.sonatype.com/display/NXRM3/REST+and+Integration+API" target="_blank">Provisioning REST API</a> which allows to upload scripts to
Nexus and execute those scripts which makes it possible to do such kind of setup in a scripted manner.</p>

<p>So now we have taken the first barrier. The next one is in front. How to test
such setups?</p>

<p>The simplest way to make experiments related to the Nexus Provisioning API is to
use a <a href="https://www.docker.com/" target="_blank">Docker</a> setup. You can simply get an default installation via a
<a href="https://hub.docker.com/r/sonatype/nexus/" target="_blank">Docker Image</a>.</p>

<p>This can be started by using the following command:</p>

<pre><code>docker run -d -p 8081:8081 --name nexus sonatype/nexus3:3.5.2
</code></pre>

<p>Afterwards you can use the <a href="https://help.sonatype.com/display/NXRM3/REST+and+Integration+API" target="_blank">example scripts for provisioning</a> as
a starting point.</p>

<p>There is a two step way to get something configured in Nexus. First upload the
script and afterwards run it. This can either been done
using <code>curl</code> manually on command line or you can use the <code>provision.sh</code> script
in <a href="https://github.com/sonatype/nexus-book-examples/tree/nexus-3.x" target="_blank">example scripting setup</a> which is much more convenient.</p>

<p>The above example project contains basic examples for different types of
setup tasks to do. So the easiest way to start is by cloning the repository
and change it based on your own requirements. I started with creating a separate
repository for keeping my scripts and changes. By the way you should use an IDE
to write the groovy scripts (IDEA IntelliJ for example). This makes implementing
scripts easier, cause you get code completion etc.</p>

<p>So now let&rsquo;s start with a real example. A script which will create a repository
(I have chosen to create a Maven repository) could look like this:</p>

<pre><code>import org.sonatype.nexus.blobstore.api.BlobStoreManager
import org.sonatype.nexus.repository.maven.LayoutPolicy
import org.sonatype.nexus.repository.storage.WritePolicy
import org.sonatype.nexus.repository.maven.VersionPolicy

def testMavenReleaseRepository = repository.createMavenHosted(
  'test-maven-repository',
  BlobStoreManager.DEFAULT_BLOBSTORE_NAME,
  true,
  VersionPolicy.RELEASE,
  WritePolicy.ALLOW_ONCE
)
</code></pre>

<p>This will create a Maven repository named <code>test-maven-repository</code> which is
configured as a release repository. That means you are not allowed to upload an
artifact a second time which is the default for release repositories
(<code>VersionPolicy.RELEASE</code>) in Maven. That&rsquo;s valid for repository managers, too.
Furthermore it will use the <code>BlobStoreManager.DEFAULT_BLOBSTORE_NAME</code>
(<code>default</code>). The <code>true</code> represents the value for the
<code>strictContentTypeValidation</code> parameter.</p>

<p>So now if you have run a script on a running Nexus repository manager instance
inside a Docker container, you can check the configuration by looking
into the UI of Nexus and see if everything is like you expected it to be. If
you find something which is not the way as expected, you simply stop the docker
container, fix your script accordingly and start your container and run the
script again.</p>

<p>Wait a minute? Running over and over again? Manually checking? Wasn&rsquo;t that the
subject at the beginning of this article? Make it reproducible?</p>

<p>So there is a better way to do. Just simply write tests for those things.
This means just pick up a testing framework which supports a kind of web
testing. I have decided to use <a href="https://cypress.io" target="_blank">Cypress</a> which was easy to setup
(unfortunately I had to register via Github. Why?) and with some kind of
searching for <a href="http://jquery.com/" target="_blank">JQuery</a> issues I had, it took me about two or three hours
to have a very good starting point.</p>

<p>So let&rsquo;s take a look how such a script looks like:</p>

<pre><code>describe('test-usage-user Starting', function() {
  beforeEach(function(){
    cy.visit('/')
    // Login as &quot;test-user&quot;
    cy.contains('Sign in').click()
    cy.get('input[name=username]').clear().type('test-user')
    cy.get('input[name=password]').clear().type('test-user')
      .type('{enter}')
  })

  it('Start page', function() {
    cy.get('label').contains('Welcome').end()
    cy.get('label').contains('Welcome to Nexus Repository Manager!').end()
  })

  it('Checking account informations.', function() {
    cy.get('span').contains('test-user').end()
    cy.get('a[data-qtip=&quot;Hi, test-user. Manage your user account.&quot;]').end()

    // Select the account overview.
    cy.contains('test-user').click()

    // check the &quot;Loading&quot; box, cause it's there only a very short time...
    cy.get('div[role=presentation]').contains('Loading')

    cy.get('span').contains('This is used as your username.')
    cy.contains('Manage your account')

    cy.contains('Sign out').end()
    cy.get('label').contains('Account').end()
    cy.get('span').contains('test-user').end()

  })
  ..
})  
</code></pre>

<p>I have to admit there had been some challenges to get things working, cause it
seemed to me that the informations on the result pages of Nexus aren&rsquo;t intended
for testing, cause they contain generated numbers etc. and unfortunately no
unique identifiers for particular parts of the output. For example an id for a
list of repositories. That made the writing of the testing a bit hard and
verbose. For example the following snippet is to extract the information
for a single line from the list of repositories:</p>

<pre><code>cy.get('table&gt;tbody&gt;tr[data-recordid=&quot;test-maven-public&quot;]&gt;td&gt;div').then(function ($columns) {
    expect($columns).to.have.length(7)
    // 0 contains the icon
    expect($columns.eq(1)).to.contain('test-maven-public')
    expect($columns.eq(2)).to.contain('group')
    expect($columns.eq(3)).to.contain('maven2')
    expect($columns.eq(4)).to.contain('Online')
    // 5 contains copy URL
    // 6 contains link to get more details
})
</code></pre>

<p>So there is no human readable unique id in the <code>table</code>, something like
<code>&lt;table id=&quot;repository-list&quot;..</code>. Only by using the above <code>data-recordid</code> it was
possible to find the correct entries which means you have to know the name of
the repositories beforehand. This means if you need to check a list of
repositories you have to repeat the above code snippet several times.</p>

<p>So improving the output in a way to add better unique id&rsquo;s in a more human
oriented way would make it much easier to get things done based on the idea of
infrastructure as code.</p>

<p>In the end the provisioning API seemed to be not completed yet. So for
example a <a href="https://stackoverflow.com/questions/39903588/nexus3-configure-ldap-with-api" target="_blank">configuration for LDAP</a> is a lot more complex
than I thought. But may be I have missed something. The current
implementation (as far as it goes) is very simple to use and makes it easy to
write such setup scripts which is a great thing.</p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'>
  <div class='categories'>
  <span class='taxonomy-icon'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M22,19a2,2,0,0,1-2,2H4a2,2,0,0,1-2-2V5A2,2,0,0,1,4,3H9l2,3h9a2,2,0,0,1,2,2Z"/>
  
</svg>
</span>
  <span class='screen-reader-text'>Categories: </span><a class='category' href='/categories/nexus'>Nexus</a>, <a class='category' href='/categories/docker'>Docker</a>, <a class='category' href='/categories/rest-api'>REST API</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/blog/2017/10/2017-10-01-mojohaus-versions-maven-plugin-version-2-dot-5-released/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>MojoHaus Version Maven Plugin Version 2.5 Released</a>
    </div><div class='next-entry sep-before'>
      <a href='/blog/2017/10/2017-10-08-apache-maven-war-plugin-version-3-dot-2-0-released/'>
        <span class='screen-reader-text'>Next post: </span>Apache Maven WAR Plugin Version 3.2.0 Released<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'>
          <section class='widget widget-social_menu sep-after'><nav aria-label='Social Menu'>
    <ul><li>
        <a href='https://github.com/khmarbaise' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Github account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>
</a>
      </li><li>
        <a href='https://twitter.com/khmarbaise' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Twitter account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
  
</svg>
</a>
      </li><li>
        <a href='mailto:info@soebes.de' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Contact via Email</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg>
</a>
      </li><li>
        <a href='https://gitlab.com/khmarbaise' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Gitlab account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M22.65 14.39L12 22.13 1.35 14.39a.84.84 0 0 1-.3-.94l1.22-3.78 2.44-7.51A.42.42 0 0 1 4.82 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.49h8.1l2.44-7.51A.42.42 0 0 1 18.6 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.51L23 13.45a.84.84 0 0 1-.35.94z"/>
  
</svg>
</a>
      </li><li>
        <a href='https://linkedin.com/in/karl-heinz-marbaise-17a15614' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Linkedin account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/>
  <rect x="2" y="9" width="4" height="12"/>
  <circle cx="4" cy="4" r="2"/>
  
</svg>
</a>
      </li></ul>
  </nav>
</section>
          <div class='copyright'>
  <p>SoEBeS &copy; 2004-2019 SoftwareEntwicklung Beratung Schulung </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__public_path__='\/assets\/js\/'</script>

<script src='/assets/js/main.0d92f56c.js'></script>
<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>

</html>

